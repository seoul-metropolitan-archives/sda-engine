<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="rmsoft.ams.seoul.st.st008.dao.St008Mapper">
    <select id="getStTakeoutRequest" resultType="St00801VO" statementType="PREPARED">
        <![CDATA[
            select
                   TAKEOUT_REQUEST_UUID takeoutRequestUuid,
                   REQUEST_NAME requestName,
                   REQUESTOR_UUID requestorUuid,
                   (SELECT USER_NAME FROM AC_USER WHERE USER_UUID = request.REQUESTOR_UUID) AS requestorName,
                   user_group.USER_GROUP_NAME userGroupName,
                   request.TAKEOUT_DATE takeoutDate,
                   request.RETURN_DATE returnDate,
                   request.RETURN_DUE_DATE returnDueDate,
                   (SELECT CODE_NAME
                    FROM AD_CODE_DETAIL
                    WHERE CODE_DETAIL_UUID = request.STATUS_UUID) AS status,
                   request.STATUS_UUID statusUuid,
                   TAKEOUT_PROPOSE takeoutPropose

            FROM ST_TAKEOUT_REQUEST request
              INNER JOIN AC_USER_GROUP_USER group_user
                ON USER_UUID = request.REQUESTOR_UUID
              INNER JOIN AC_USER_GROUP user_group
                ON user_group.USER_GROUP_UUID = group_user.USER_GROUP_UUID

        ]]>
    </select>
    <select id="getStTakeoutRecordResult" resultType="St00802VO" statementType="PREPARED">
        <![CDATA[
        select
               TAKEOUT_RECORD_RESULT_UUID takeoutRecordResultUuid,
               TAKEOUT_REQUEST_UUID takeoutRequestUuid,
               record_result.AGGREGATION_UUID aggregationUuid,
               B.code,
               B.title,
               B."level",
               B."type",
               B.publishedStatus,
               B.author,
               B.descStrDate descStrDate,
               B.descEdDate descEdDate,
               repository.REPOSITORY_NAME repositoryName, -- 서고
               shelf.SHELF_NAME shelfName, -- 서가
               (location.ROW_NO || '행 ' || location.COLUMN_NO || '열') as locationName -- 행렬단

        FROM ST_TAKEOUT_RECORD_RESULT record_result
                  INNER JOIN (
                    SELECT ar.AGGREGATION_UUID, ar.CONTAINER_UUID    FROM RC_ITEM item
                      INNER JOIN ST_ARRANGE_RECORDS_RESULT ar
                        ON ar.AGGREGATION_UUID = item.AGGREGATION_UUID
                    ) etc
                  ON etc.AGGREGATION_UUID = record_result.AGGREGATION_UUID
                  INNER JOIN ST_ARRANGE_CONTAINERS_RESULT acr
                    ON acr.CONTAINER_UUID = etc.CONTAINER_UUID
                  INNER JOIN ST_LOCATION location
                    ON location.LOCATION_UUID = acr.LOCATION_UUID
                  INNER JOIN ST_CONTAINER container
                    ON container.CONTAINER_UUID = etc.CONTAINER_UUID
                  INNER JOIN ST_SHELF shelf
                    ON shelf.SHELF_UUID = location.SHELF_UUID
                  INNER JOIN ST_REPOSITORY repository
                    ON repository.REPOSITORY_UUID = shelf.REPOSITORY_UUID
                  INNER JOIN (SELECT AGGREGATION_UUID                                                                         as uuid,
                                     1                                                                                        as orderNo,
                                     (SELECT CODE_NAME
                                      FROM AD_CODE_DETAIL
                                      WHERE CODE_DETAIL_UUID = Z1.PUBLISHED_STATUS_UUID)                                      as publishedStatus,
                                     AGGREGATION_CODE                                                                         as code,
                                     TITLE                                                                                    as title,
                                     (SELECT CODE_NAME
                                      FROM AD_CODE_DETAIL
                                      WHERE CODE_DETAIL_UUID = Z1.TYPE_UUID)                                                  as "type",
                                     (SELECT TO_CHAR(LEVEL_NO)
                                      FROM RC_LEVEL
                                      WHERE LEVEL_UUID = Z1.LEVEL_UUID)                                                       as "level",
                                     AUTHOR                                                                                   as author,
                                     DESCRIPTION_START_DATE                                                                   as descStrDate,
                                     DESCRIPTION_END_DATE                                                                     as descEdDate,
                                     DESCRIPTION                                                                              as description,
                                     NOTES                                                                                    as notes,
                                     ((SELECT COUNT(*) FROM RC_AGGREGATION WHERE PARENT_AGGREGATION_UUID = Z1.AGGREGATION_UUID) +
                                      (SELECT COUNT(*)
                                       FROM RC_ITEM
                                       WHERE AGGREGATION_UUID = Z1.AGGREGATION_UUID))                                         as childCnt
                              FROM RC_AGGREGATION Z1
                              UNION ALL SELECT ITEM_UUID                                                                    as uuid,
                                               2                                                                            as orderNo,
                                               (SELECT CODE_NAME
                                                FROM AD_CODE_DETAIL
                                                WHERE CODE_DETAIL_UUID = Z1.PUBLISHED_STATUS_UUID)                          as publishedStatus,
                                               ITEM_CODE                                                                    as code,
                                               TITLE                                                                        as title,
                                               (SELECT CODE_NAME
                                                FROM AD_CODE_DETAIL
                                                WHERE CODE_DETAIL_UUID = Z1.TYPE_UUID)                                      as "type",
                                               ''                                                                           as "level",
                                               AUTHOR                                                                       as author,
                                               DESCRIPTION_START_DATE                                                       as descStrDate,
                                               DESCRIPTION_END_DATE                                                         as descEdDate,
                                               DESCRIPTION                                                                  as description,
                                               NOTES                                                                        as notes,
                                               0                                                                            as childCnt
                                        FROM RC_ITEM Z1) B on B.UUID = record_result.AGGREGATION_UUID
        <where>
            1=1

        </where>
    ]]>
     </select>
</mapper>
